# -*- coding: utf-8 -*-
"""
Created on Sat Aug 11 23:02:01 2018

@author: 丁凡彧
"""

import pandas as pd  
import numpy as np
import haversine as ha
from keras.models import load_model
#导入训练数据
X = pd.read_csv('../../data/more-poi/TX-246w(2).csv',index_col=0) 
Y= pd.read_csv('../../data/more-poi/Y-246w(3)-90%.csv',index_col=0)



#计算特征向量所需数据
poi = pd.read_csv('../../data/more-poi/poi-lnglat.csv')
df= pd.read_csv('../../data/more-poi/YCL-user-poi-246w(3).csv')
poitz = pd.read_csv('../../data/2/161w/poi-TZ3-161w(6-100).csv')
poitz.columns = [i for i in range(31)]
usertz=pd.read_csv('../../data/2/161w/user-TZ2-161w(6-100).csv',index_col=0)
#计算可达性函数
def kedaxing(lon1, lat1, lon2, lat2):# 经度1，纬度1，经度2，纬度2 （十进制度数）  
     dis=ha.haversine(lon1, lat1, lon2, lat2)
     dis=abs(dis)
     if dis<=500:
        dtype=1
     elif 500<dis and dis<=1000:
        dtype=2
     elif 1000<dis and dis<=2000:
        dtype=3
     elif 2000<dis and dis<=5000:
        dtype=4
     elif 5000<dis:
        dtype=5
     return dtype


def forcase_tz(idnum,poinum,i):#用户id,第几个
#按照用户编号分割可达性     
    d=df[(df.id==idnum)]
    d=d.drop_duplicates(['poi'])
    d=d.reset_index(drop=True)
#获得上一个地点与预测地点经纬度
    lon1=d.loc[i,'lng']
    lat1=d.loc[i,'lat']
    lon2=poi.loc[(poi.id==poinum),'lng'].values[0]
    lat2=poi.loc[(poi.id==poinum),'lat'].values[0]
#计算预测地点可达性
    kdx=kedaxing(lon1, lat1, lon2, lat2)
    poi_tz=poitz[poinum].tolist()                                               
    poi_tz.append(kdx) 
    user_tz=list(usertz.loc[idnum])
#景点和用户特征向量相乘得到特征矩阵
    poi_tz=np.mat(poi_tz)
    user_tz=np.mat(user_tz)
    tzjz=np.array(poi_tz.T*user_tz)
#展开特征矩阵得到特征向量
    tz=tzjz.flatten()
    tz=tz.tolist()
    return tz

def evaluate_forecasts(pre,true):
    pre_true= list((set(pre).union(set(true)))^(set(pre)^set(true)))
    return len(pre_true)       



model = load_model('161w-f2-90%-128b.h5')      
model2 = load_model('model(2).h5')  
#model3 = load_model('model(3).h5')  

#获取用户编号
ids = X.index.tolist()
ids = list(set(ids))
ids.sort()
num=0
for i in range(len(ids)):
    pre=[]
    idnum=ids[i]
    test_x=X[X.index==idnum].values
    test_y=Y[Y.index==idnum].values
    test_y=test_y[1:,0].tolist()
    n_tese=1#int(test_y.shape[0]/3)
    test_x = test_x.reshape((n_tese,13, test_x.shape[1]))
    
    d=df[(df.id==idnum)]
    d=d.drop_duplicates(['poi'])
    #预测
    '''
    result = model3.predict(test_x,batch_size=128,verbose=0)
    result_max =  np.argmax(result, axis = 1) 
    poinum=result_max[0]
    pre.append(poinum)
    
#预测值特征加入输入中预测下一个值 
    j=d.shape[0]-3
    test_x[0][j]=forcase_tz(idnum,poinum,j)
    '''
    result = model2.predict(test_x,batch_size=1,verbose=0)
    result_max =  np.argmax(result, axis = 1) 
    poinum=result_max[0]
    pre.append(poinum)
    j=d.shape[0]-2
    test_x[0][j]=forcase_tz(idnum,poinum,j)
    result = model.predict(test_x,batch_size=1,verbose=0)
    result_max =  np.argmax(result, axis = 1) 
    poinum=result_max[0]
    pre.append(poinum)
    num = num + evaluate_forecasts(pre,test_y)
print(num/(Y.shape[0]/3*2))
'''    
#递归多步预测策略
    for j in range(d.shape[0]-4,d.shape[0]-1):
#预测
        result = model.predict(test_x,batch_size=128,verbose=0)
        result_max =  np.argmax(result, axis = 1) 
        poinum=result_max[0]
        pre.append(poinum)
#预测值特征加入输入中预测下一个值    
        test_x[0][j]=forcase_tz(idnum,poinum,j)
    num = num + evaluate_forecasts(pre,test_y)
'''



                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
