# -*- coding: utf-8 -*-
"""
Created on Sat Aug 11 23:02:01 2018

@author: 丁凡彧
"""

import pandas as pd  
from keras.models import Sequential
from keras.layers import Dense, Dropout,Bidirectional
from keras.layers import Masking
from keras.layers import GRU
from matplotlib import pyplot
#X训练集
df1 = pd.read_csv('../../data/more-poi/X-246w(5)-90%-1.csv') 
df2 = pd.read_csv('../../data/more-poi/X-246w(5)-90%-2.csv') 
#合并并删除无用集合
frames=[df1,df2]
X=pd.concat(frames)
del df1
del df2

del frames
#读取Y集合即标签集
Y= pd.read_csv('../../data/more-poi/TY-246w(5)-90%.csv')
X=X.fillna(0)
#转化为矩阵
train_x = X.values
del X
train_y = Y.values
del Y
#转换训练集为3D集合[样本，时间步，特征]
train_x = train_x.reshape((train_y.shape[0],13, train_x.shape[1]))
print(train_x.shape, train_y.shape)
#序列搭建模型
model = Sequential()
#屏蔽层，屏蔽0输入内容
model.add(Masking(mask_value=0,input_shape=(13,408)))
#双向GRU模型
model.add(Bidirectional(GRU(13, input_shape=(train_x.shape[1], train_x.shape[2]))))
#Dropout(0.5)防止过拟合
model.add(Dropout(0.5))
#对应31个景点one-hot向量的输出层
model.add(Dense(31, activation='softmax'))
#采用adam优化器
model.compile(loss='mae', optimizer='adam',metrics = ['accuracy'])
# 训练网络
history = model.fit(train_x, train_y, epochs=20, batch_size=128,validation_split=0.3, 
                    verbose=2, shuffle=False)
# 打印训练曲线
pyplot.plot(history.history['loss'], label='train')
pyplot.plot(history.history['val_loss'], label='test')
pyplot.legend()
pyplot.show()
pyplot.plot(history.history['acc'], label='train')
pyplot.plot(history.history['val_acc'], label='test')
pyplot.legend()
pyplot.show()      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        